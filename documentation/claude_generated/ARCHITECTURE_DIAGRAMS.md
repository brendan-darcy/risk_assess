# Architecture Diagrams
## Property Reporting System Refactoring

Visual representations of the new architecture.

---

## 1. Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │     PDF      │  │  HTML Report │  │     Maps     │             │
│  │   Reports    │  │              │  │ Visualizations│             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
│         │                  │                  │                      │
│         └──────────────────┴──────────────────┘                     │
│                            ↓                                         │
│                   BaseReportGenerator                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ Consumes
┌─────────────────────────────────────────────────────────────────────┐
│                          DATA LAYER                                  │
│  Processed JSON Files (data/property_reports/)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  property_   │  │ geospatial_  │  │ comparable_  │             │
│  │  details     │  │  layers      │  │   sales      │             │
│  │   .json      │  │   .json      │  │   .json      │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  property_   │  │ mesh_block_  │  │ development_ │             │
│  │  impacts     │  │  analysis    │  │  approvals   │             │
│  │   .json      │  │   .json      │  │   .json      │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ Generated by
┌─────────────────────────────────────────────────────────────────────┐
│                         ETL LAYER                                    │
│  Extract → Transform → Load Pipelines                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  Property    │  │ Geospatial   │  │ Comparable   │             │
│  │     ETL      │  │     ETL      │  │     ETL      │             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
│         │                  │                  │                      │
│         └──────────────────┴──────────────────┘                     │
│                            ↓                                         │
│                    BaseETLProcessor                                  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ Uses
┌─────────────────────────────────────────────────────────────────────┐
│                         API LAYER                                    │
│  API Clients (Authentication + Requests)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  CoreLogic   │  │    Google    │  │    Vicmap    │             │
│  │   Client     │  │   Places     │  │   Client     │             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
│         │                  │                  │                      │
│         └──────────────────┴──────────────────┘                     │
│                            ↓                                         │
│                      BaseAPIClient                                   │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                       EXTERNAL APIs                                  │
│  CoreLogic | Google Places | Vicmap Geospatial                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. Data Flow

```
┌──────────────┐
│  User Input  │
│   Address    │
│ Property ID  │
└──────┬───────┘
       │
       ↓
┌──────────────────────────────────────────────────────────────┐
│                    ORCHESTRATION                              │
│  run_comprehensive_analysis.py                               │
└──────────────────────────────────────────────────────────────┘
       │
       ├─────────────────────────────────────────────────────┐
       │                                                       │
       ↓                                                       ↓
┌─────────────┐                                        ┌─────────────┐
│ API CLIENTS │                                        │ ETL PIPELINE│
│ Initialize  │                                        │  Execute    │
└─────┬───────┘                                        └─────┬───────┘
      │                                                      │
      │ ┌──────────────┐                                    │
      ├─┤ CoreLogic    │                                    │
      │ └──────────────┘                                    │
      │ ┌──────────────┐                                    │
      ├─┤ Google Places│                                    │
      │ └──────────────┘                                    │
      │ ┌──────────────┐                                    │
      └─┤ Vicmap       │                                    │
        └──────────────┘                                    │
                                                            │
        ┌───────────────────────────────────────────────────┘
        │
        ↓
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Property ETL   │    │ Geospatial ETL  │    │ Comparable ETL  │
│                 │    │                 │    │                 │
│ Extract ────────┼───→│ Extract ────────┼───→│ Extract ────────┤
│ Transform       │    │ Transform       │    │ Transform       │
│ Load ────┐      │    │ Load ────┐      │    │ Load ────┐      │
└──────────┼──────┘    └──────────┼──────┘    └──────────┼──────┘
           │                      │                       │
           ↓                      ↓                       ↓
     ┌──────────┐          ┌──────────┐          ┌──────────┐
     │property_ │          │geospatial│          │comparable│
     │details   │          │_layers   │          │_sales    │
     │.json     │          │.json     │          │.json     │
     └──────────┘          └──────────┘          └──────────┘
           │                      │                       │
           └──────────────────────┴───────────────────────┘
                                  │
                                  ↓
                    ┌───────────────────────────┐
                    │   Report Generator        │
                    │   gather_data()           │
                    │   generate()              │
                    └─────────────┬─────────────┘
                                  │
                                  ↓
                    ┌───────────────────────────┐
                    │ comprehensive_report.json │
                    └─────────────┬─────────────┘
                                  │
                                  ↓
                    ┌───────────────────────────┐
                    │   PDF Generator           │
                    │   render_template()       │
                    └─────────────┬─────────────┘
                                  │
                                  ↓
                    ┌───────────────────────────┐
                    │   final_report.pdf        │
                    └───────────────────────────┘
```

---

## 3. Class Hierarchy

```
┌─────────────────────────────────────────────────────────────┐
│                      BASE CLASSES                            │
│                   (scripts/core/)                            │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ↓                   ↓                   ↓
┌───────────────┐  ┌─────────────────┐  ┌───────────────────┐
│BaseAPIClient  │  │BaseETLProcessor │  │BaseReportGenerator│
├───────────────┤  ├─────────────────┤  ├───────────────────┤
│authenticate() │  │extract()        │  │gather_data()      │
│make_request() │  │transform()      │  │generate()         │
│get_token()    │  │load()           │  │validate()         │
│_apply_rate_   │  │validate()       │  │save_json()        │
│  limit()      │  │save_json()      │  │load_processed_    │
│_cache()       │  │flatten_dict()   │  │  file()           │
└───────┬───────┘  └────────┬────────┘  └─────────┬─────────┘
        │                   │                      │
        │                   │                      │
  ┌─────┴─────┐      ┌──────┴──────┐      ┌───────┴────────┐
  │           │      │             │      │                │
  ↓           ↓      ↓             ↓      ↓                ↓
┌─────┐  ┌──────┐ ┌────┐  ┌──────────┐ ┌──────┐  ┌─────────┐
│Core │  │Google│ │Prop│  │Geospatial│ │Compre│  │  PDF    │
│Logic│  │Places│ │erty│  │   ETL    │ │hensive│ │Generator│
│Client│ │Client│ │ETL │  │          │ │Report │ │         │
└─────┘  └──────┘ └────┘  └──────────┘ └──────┘  └─────────┘
```

---

## 4. Before vs After: Code Duplication

### BEFORE: Code Scattered Everywhere

```
┌─────────────────────────────────────────────────────────────┐
│                   corelogic_processor_updated.py             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • Authentication logic (60 lines)                    │   │
│  │ • Request handling (40 lines)                        │   │
│  │ • Error handling (30 lines)                          │   │
│  │ • JSON I/O (20 lines)                                │   │
│  │ • Property processing (200 lines)                    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   property_data_processor.py                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • Authentication logic (60 lines) ← DUPLICATE        │   │
│  │ • Request handling (40 lines) ← DUPLICATE            │   │
│  │ • Error handling (30 lines) ← DUPLICATE              │   │
│  │ • JSON I/O (20 lines) ← DUPLICATE                    │   │
│  │ • Property processing (300 lines)                    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              comprehensive_property_report.py                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • Authentication logic (60 lines) ← DUPLICATE        │   │
│  │ • Request handling (40 lines) ← DUPLICATE            │   │
│  │ • Error handling (30 lines) ← DUPLICATE              │   │
│  │ • JSON I/O (20 lines) ← DUPLICATE                    │   │
│  │ • Report generation (400 lines)                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   google_api_processor.py                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • Authentication logic (40 lines) ← DUPLICATE        │   │
│  │ • Request handling (40 lines) ← DUPLICATE            │   │
│  │ • Error handling (30 lines) ← DUPLICATE              │   │
│  │ • JSON I/O (20 lines) ← DUPLICATE                    │   │
│  │ • Places processing (300 lines)                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

Total: ~1,000+ lines of DUPLICATED infrastructure code
```

### AFTER: DRY Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    scripts/core/                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ BaseAPIClient                                        │   │
│  │ • Authentication logic (80 lines) ← ONCE            │   │
│  │ • Request handling (100 lines) ← ONCE               │   │
│  │ • Error handling (40 lines) ← ONCE                  │   │
│  │ • Rate limiting (30 lines) ← ONCE                   │   │
│  │ • Caching (50 lines) ← ONCE                         │   │
│  │ • Retry logic (40 lines) ← ONCE                     │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ BaseETLProcessor                                     │   │
│  │ • JSON I/O (60 lines) ← ONCE                        │   │
│  │ • Validation (40 lines) ← ONCE                      │   │
│  │ • Flatten dict (30 lines) ← ONCE                    │   │
│  │ • Pipeline orchestration (50 lines) ← ONCE          │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ BaseReportGenerator                                  │   │
│  │ • Data loading (50 lines) ← ONCE                    │   │
│  │ • Validation (30 lines) ← ONCE                      │   │
│  │ • Report orchestration (40 lines) ← ONCE            │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓ Inherited by
┌─────────────────────────────────────────────────────────────┐
│                  scripts/api/                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ CoreLogicClient (150 lines) ← Only business logic   │   │
│  │ GooglePlacesClient (100 lines) ← Only business logic│   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  scripts/etl/                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ PropertyETL (120 lines) ← Only transform logic      │   │
│  │ GeospatialETL (100 lines) ← Only transform logic    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

Total: ~500 lines of infrastructure code (60% reduction)
      + ~400 lines of business logic
      = ~900 lines total (vs 1,000+ duplicated lines)
```

---

## 5. Request Flow Sequence

```
User Request
     │
     ↓
┌────────────────────────────────────┐
│ run_comprehensive_analysis.py      │
└────────────────────────────────────┘
     │
     ├──→ Step 1: Initialize API Clients
     │    ┌─────────────────────────┐
     │    │ CoreLogicClient.from_env()
     │    │  ↓
     │    │ authenticate()
     │    │  ↓
     │    │ get_access_token()
     │    └─────────────────────────┘
     │
     ├──→ Step 2: Run Property ETL
     │    ┌─────────────────────────┐
     │    │ PropertyETL.run()
     │    │  ↓
     │    │ extract(property_id)
     │    │  │ → api_client.get_property_details()
     │    │  │   → BaseAPIClient.make_request()
     │    │  │     → apply_rate_limit()
     │    │  │     → requests.get()
     │    │  │     → cache_response()
     │    │  ↓
     │    │ transform(raw_data)
     │    │  │ → flatten_dict()
     │    │  │ → validate_data()
     │    │  ↓
     │    │ load(transformed_data)
     │    │  │ → save_json()
     │    │  ↓
     │    │ property_details.json ✓
     │    └─────────────────────────┘
     │
     ├──→ Step 3: Run Geospatial ETL
     │    ┌─────────────────────────┐
     │    │ GeospatialETL.run()
     │    │  ↓
     │    │ extract(property_id)
     │    │  ↓
     │    │ transform(raw_data)
     │    │  ↓
     │    │ load(transformed_data)
     │    │  ↓
     │    │ geospatial_layers.json ✓
     │    └─────────────────────────┘
     │
     ├──→ Step 4: Run Comparable ETL
     │    ┌─────────────────────────┐
     │    │ ComparableETL.run()
     │    │  ↓
     │    │ comparable_sales.json ✓
     │    └─────────────────────────┘
     │
     ├──→ Step 5: Generate Comprehensive Report
     │    ┌─────────────────────────┐
     │    │ ComprehensiveReportGenerator.run()
     │    │  ↓
     │    │ gather_data()
     │    │  │ → load_processed_file(property_details.json)
     │    │  │ → load_processed_file(geospatial_layers.json)
     │    │  │ → load_processed_file(comparable_sales.json)
     │    │  ↓
     │    │ generate()
     │    │  │ → aggregate_data()
     │    │  │ → validate_report()
     │    │  │ → save_json()
     │    │  ↓
     │    │ comprehensive_report.json ✓
     │    └─────────────────────────┘
     │
     └──→ Step 6: Generate PDF
          ┌─────────────────────────┐
          │ PDFReportGenerator.run()
          │  ↓
          │ gather_data()
          │  │ → load(comprehensive_report.json)
          │  ↓
          │ generate()
          │  │ → render_template()
          │  │ → save_pdf()
          │  ↓
          │ final_report.pdf ✓
          └─────────────────────────┘
```

---

## 6. File Organization: Before vs After

### BEFORE: Flat Structure

```
scripts/
├── utils/  (ALL MIXED TOGETHER)
│   ├── corelogic_processor_updated.py      (API + Processing)
│   ├── property_data_processor.py          (API + Processing)
│   ├── geospatial_api_client.py           (API Only)
│   ├── google_api_processor.py            (API + Processing)
│   ├── comparable_sales_generator.py       (Processing + Generation)
│   ├── market_data_processor.py           (API + Processing)
│   ├── mesh_block_analysis_pipeline.py    (Pipeline + GIS)
│   └── ... (10+ more mixed files)
│
└── (40+ scripts all in root)
```

### AFTER: Organized by Responsibility

```
scripts/
├── core/                    ← BASE CLASSES
│   ├── base_api_client.py
│   ├── base_etl_processor.py
│   ├── base_report_generator.py
│   ├── base_data_processor.py
│   ├── exceptions.py
│   └── interfaces.py
│
├── api/                     ← API CLIENTS ONLY
│   ├── corelogic_client.py
│   ├── google_places_client.py
│   ├── vicmap_client.py
│   └── corelogic_images_client.py
│
├── etl/                     ← ETL PIPELINES ONLY
│   ├── property_etl.py
│   ├── geospatial_etl.py
│   ├── comparable_sales_etl.py
│   └── places_impact_etl.py
│
├── processors/              ← BUSINESS LOGIC ONLY
│   ├── comparable_processor.py
│   ├── impact_processor.py
│   └── market_processor.py
│
├── generators/              ← REPORT GENERATION ONLY
│   ├── comprehensive_report_generator.py
│   ├── pdf_report_generator.py
│   └── visualization_generator.py
│
├── extractors/              ← PDF EXTRACTION (unchanged)
│   ├── planning_zone_extractor.py
│   └── development_approvals_extractor.py
│
└── utils/                   ← SHARED UTILITIES ONLY
    ├── pipeline_utils.py
    ├── config.py
    └── exceptions.py
```

---

**Document Version:** 1.0
**Date:** 2025-11-10
**Purpose:** Visual reference for new architecture
